/**
 * Class Applier module for Rangy.
 * Adds, removes and toggles classes on Ranges and Selections
 *
 * Part of Rangy, a cross-browser JavaScript range and selection library
 * https://github.com/timdown/rangy
 *
 * Depends on Rangy core.
 *
 * Copyright 2016, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3.1-dev
 * Build date: 13 March 2016
 */
!function(e,t){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(t.rangy)}(function(e){return e.createModule("ClassApplier",["WrappedSelection"],function(e,t){function n(e,t){for(var n in e)if(e.hasOwnProperty(n)&&t(n,e[n])===!1)return!1;return!0}function s(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function r(e,t){return!!e&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e)}function i(e,t){if("object"==typeof e.classList)return e.classList.contains(t);var n="string"==typeof e.className,s=n?e.className:e.getAttribute("class");return r(s,t)}function o(e,t){if("object"==typeof e.classList)e.classList.add(t);else{var n="string"==typeof e.className,s=n?e.className:e.getAttribute("class");s?r(s,t)||(s+=" "+t):s=t,n?e.className=s:e.setAttribute("class",s)}}function a(e){var t="string"==typeof e.className;return t?e.className:e.getAttribute("class")}function l(e){return e&&e.split(/\s+/).sort().join(" ")}function u(e){return l(a(e))}function f(e,t){return u(e)==u(t)}function c(e,t){for(var n=t.split(/\s+/),r=0,o=n.length;o>r;++r)if(!i(e,s(n[r])))return!1;return!0}function p(e){var t=e.parentNode;return t&&1==t.nodeType&&!/^(textarea|style|script|select|iframe)$/i.test(t.nodeName)}function d(e,t,n,s,r){var i=e.node,o=e.offset,a=i,l=o;i==s&&o>r&&++l,i!=t||o!=n&&o!=n+1||(a=s,l+=r-n),i==t&&o>n+1&&--l,e.node=a,e.offset=l}function h(e,t,n){e.node==t&&e.offset>n&&--e.offset}function m(e,t,n,s){-1==n&&(n=t.childNodes.length);var r=e.parentNode,i=j.getNodeIndex(e);D(s,function(e){d(e,r,i,t,n)}),t.childNodes.length==n?t.appendChild(e):t.insertBefore(e,t.childNodes[n])}function g(e,t){var n=e.parentNode,s=j.getNodeIndex(e);D(t,function(e){h(e,n,s)}),j.removeNode(e)}function N(e,t,n,s,r){for(var i,o=[];i=e.firstChild;)m(i,t,n++,r),o.push(i);return s&&g(e,r),o}function v(e,t){return N(e,e.parentNode,j.getNodeIndex(e),!0,t)}function y(e,t){var n=e.cloneRange();n.selectNodeContents(t);var s=n.intersection(e),r=s?s.toString():"";return""!=r}function C(e){for(var t,n=e.getNodes([3]),s=0;(t=n[s])&&!y(e,t);)++s;for(var r=n.length-1;(t=n[r])&&!y(e,t);)--r;return n.slice(s,r+1)}function T(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,s,r,i=0,o=e.attributes.length;o>i;++i)if(n=e.attributes[i],r=n.name,"class"!=r){if(s=t.attributes.getNamedItem(r),null===n!=(null===s))return!1;if(n.specified!=s.specified)return!1;if(n.specified&&n.nodeValue!==s.nodeValue)return!1}return!0}function E(e,t){for(var n,s=0,r=e.attributes.length;r>s;++s)if(n=e.attributes[s].name,(!t||!z(t,n))&&e.attributes[s].specified&&"class"!=n)return!0;return!1}function b(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||F(e)&&!F(e.parentNode))}function A(e){return(F(e)||1!=e.nodeType&&F(e.parentNode))&&!b(e)}function S(e){return e&&1==e.nodeType&&!G.test(q(e,"display"))}function x(e){if(0==e.data.length)return!0;if(J.test(e.data))return!1;var t=q(e.parentNode,"whiteSpace");switch(t){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return S(e.previousSibling)||S(e.nextSibling)}function R(e){var t,n,s=[];for(t=0;n=e[t++];)s.push(new $(n.startContainer,n.startOffset),new $(n.endContainer,n.endOffset));return s}function P(e,t){for(var n,s,r,i=0,o=e.length;o>i;++i)n=e[i],s=t[2*i],r=t[2*i+1],n.setStartAndEnd(s.node,s.offset,r.node,r.offset)}function w(e,t){return j.isCharacterDataNode(e)?0==t?!!e.previousSibling:t==e.length?!!e.nextSibling:!0:t>0&&t<e.childNodes.length}function O(e,n,s,r){var i,o,a=0==s;if(j.isAncestorOf(n,e))return e;if(j.isCharacterDataNode(n)){var l=j.getNodeIndex(n);if(0==s)s=l;else{if(s!=n.length)throw t.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+s+" in "+n.data);s=l+1}n=n.parentNode}if(w(n,s)){i=n.cloneNode(!1),o=n.parentNode,i.id&&i.removeAttribute("id");for(var u,f=0;u=n.childNodes[s];)m(u,i,f++,r);return m(i,o,j.getNodeIndex(n)+1,r),n==e?i:O(e,o,j.getNodeIndex(i),r)}if(e!=n){i=n.parentNode;var c=j.getNodeIndex(n);return a||c++,O(e,i,c,r)}return e}function I(e,t){return e.namespaceURI==t.namespaceURI&&e.tagName.toLowerCase()==t.tagName.toLowerCase()&&f(e,t)&&T(e,t)&&"inline"==q(e,"display")&&"inline"==q(t,"display")}function W(e){var t=e?"nextSibling":"previousSibling";return function(n,s){var r=n.parentNode,i=n[t];if(i){if(i&&3==i.nodeType)return i}else if(s&&(i=r[t],i&&1==i.nodeType&&I(r,i))){var o=i[e?"firstChild":"lastChild"];if(o&&3==o.nodeType)return o}return null}}function L(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];var t=this.isElementMerge?e.lastChild:e;t&&(this.textNodes[0]=t)}function M(e,t,r){var i,o,a,u,f=this;f.cssClass=f.className=e;var c=null,p={};if("object"==typeof t&&null!==t){for("undefined"!=typeof t.elementTagName&&(t.elementTagName=t.elementTagName.toLowerCase()),r=t.tagNames,c=t.elementProperties,p=t.elementAttributes,o=0;u=X[o++];)t.hasOwnProperty(u)&&(f[u]=t[u]);i=t.normalize}else i=t;f.normalize="undefined"==typeof i?!0:i,f.attrExceptions=[];var d=document.createElement(f.elementTagName);f.elementProperties=f.copyPropertiesToElement(c,d,!0),n(p,function(e,t){f.attrExceptions.push(e),p[e]=""+t}),f.elementAttributes=p,f.elementSortedClassName=f.elementProperties.hasOwnProperty("className")?l(f.elementProperties.className+" "+e):e,f.applyToAnyTagName=!1;var h=typeof r;if("string"==h)"*"==r?f.applyToAnyTagName=!0:f.tagNames=s(r.toLowerCase()).split(/\s*,\s*/);else if("object"==h&&"number"==typeof r.length)for(f.tagNames=[],o=0,a=r.length;a>o;++o)"*"==r[o]?f.applyToAnyTagName=!0:f.tagNames.push(r[o].toLowerCase());else f.tagNames=[f.elementTagName]}function H(e,t,n){return new M(e,t,n)}var j=e.dom,$=j.DomPosition,z=j.arrayContains,B=e.util,D=B.forEach,U="span",V=B.isHostMethod(document,"createElementNS"),k=function(){function e(e,t,n){return t&&n?" ":""}return function(t,n){if("object"==typeof t.classList)t.classList.remove(n);else{var s="string"==typeof t.className,r=s?t.className:t.getAttribute("class");r=r.replace(new RegExp("(^|\\s)"+n+"(\\s|$)"),e),s?t.className=r:t.setAttribute("class",r)}}}(),q=j.getComputedStyleProperty,F=function(){var e=document.createElement("div");return"boolean"==typeof e.isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return e&&1==e.nodeType&&"false"!=e.contentEditable?"true"==e.contentEditable||F(e.parentNode):!1}}(),G=/^inline(-block|-table)?$/i,J=/[^\r\n\t\f \u200B]/,K=W(!1),Q=W(!0);L.prototype={doMerge:function(e){var t=this.textNodes,n=t[0];if(t.length>1){var s,r=j.getNodeIndex(n),i=[],o=0;D(t,function(t,a){s=t.parentNode,a>0&&(s.removeChild(t),s.hasChildNodes()||j.removeNode(s),e&&D(e,function(e){e.node==t&&(e.node=n,e.offset+=o),e.node==s&&e.offset>r&&(--e.offset,e.offset==r+1&&len-1>a&&(e.node=n,e.offset=o))})),i[a]=t.data,o+=t.data.length}),n.data=i.join("")}return n.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){var e=[];return D(this.textNodes,function(t,n){e[n]="'"+t.data+"'"}),"[Merge("+e.join(",")+")]"}};var X=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],Y={};M.prototype={elementTagName:U,elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(e,t,n){var s,r,i,a,u,f,c={};for(var p in e)if(e.hasOwnProperty(p))if(a=e[p],u=t[p],"className"==p)o(t,a),o(t,this.className),t[p]=l(t[p]),n&&(c[p]=a);else if("style"==p){r=u,n&&(c[p]=i={});for(s in e[p])e[p].hasOwnProperty(s)&&(r[s]=a[s],n&&(i[s]=r[s]));this.attrExceptions.push(p)}else t[p]=a,n&&(c[p]=t[p],f=Y.hasOwnProperty(p)?Y[p]:p,this.attrExceptions.push(f));return n?c:""},copyAttributesToElement:function(e,t){for(var n in e)e.hasOwnProperty(n)&&!/^class(?:Name)?$/i.test(n)&&t.setAttribute(n,e[n])},appliesToElement:function(e){return z(this.tagNames,e.tagName.toLowerCase())},getEmptyElements:function(e){var t=this;return e.getNodes([1],function(e){return t.appliesToElement(e)&&!e.hasChildNodes()})},hasClass:function(e){return 1==e.nodeType&&(this.applyToAnyTagName||this.appliesToElement(e))&&i(e,this.className)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||A(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&x(e)},postApply:function(e,t,n,s){var r,i,o=e[0],a=e[e.length-1],l=[],u=o,f=a,c=0,p=a.length;D(e,function(e){i=K(e,!s),i?(r||(r=new L(i),l.push(r)),r.textNodes.push(e),e===o&&(u=r.textNodes[0],c=u.length),e===a&&(f=r.textNodes[0],p=r.getLength())):r=null});var d=Q(a,!s);if(d&&(r||(r=new L(a),l.push(r)),r.textNodes.push(d)),l.length){for(var h=0,m=l.length;m>h;++h)l[h].doMerge(n);t.setStartAndEnd(u,c,f,p)}},createContainer:function(e){var t,n=j.getDocument(e),s=V&&!j.isHtmlNamespace(e)&&(t=e.namespaceURI)?n.createElementNS(e.namespaceURI,this.elementTagName):n.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,s,!1),this.copyAttributesToElement(this.elementAttributes,s),o(s,this.className),this.onElementCreate&&this.onElementCreate(s,this),s},elementHasProperties:function(e,t){var s=this;return n(t,function(t,n){if("className"==t)return c(e,n);if("object"==typeof n){if(!s.elementHasProperties(e[t],n))return!1}else if(e[t]!==n)return!1})},elementHasAttributes:function(e,t){return n(t,function(t,n){return e.getAttribute(t)!==n?!1:void 0})},applyToTextNode:function(e){if(p(e)){var t=e.parentNode;if(1==t.childNodes.length&&this.useExistingElements&&this.appliesToElement(t)&&this.elementHasProperties(t,this.elementProperties)&&this.elementHasAttributes(t,this.elementAttributes))o(t,this.className);else{var n=e.parentNode,s=this.createContainer(n);n.insertBefore(s,e),s.appendChild(e)}}},isRemovable:function(e){return e.tagName.toLowerCase()==this.elementTagName&&u(e)==this.elementSortedClassName&&this.elementHasProperties(e,this.elementProperties)&&!E(e,this.attrExceptions)&&this.elementHasAttributes(e,this.elementAttributes)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){var t=this,n=e.getNodes([1],function(e){return t.isEmptyContainer(e)}),s=[e],r=R(s);D(n,function(e){g(e,r)}),P(s,r)},undoToTextNode:function(e,t,n,s){if(!t.containsNode(n)){var r=t.cloneRange();r.selectNode(n),r.isPointInRange(t.endContainer,t.endOffset)&&(O(n,t.endContainer,t.endOffset,s),t.setEndAfter(n)),r.isPointInRange(t.startContainer,t.startOffset)&&(n=O(n,t.startContainer,t.startOffset,s))}this.isRemovable(n)?v(n,s):k(n,this.className)},splitAncestorWithClass:function(e,t,n){var s=this.getSelfOrAncestorWithClass(e);s&&O(s,e,t,n)},undoToAncestor:function(e,t){this.isRemovable(e)?v(e,t):k(e,this.className)},applyToRange:function(e,t){var n=this;t=t||[];var s=R(t||[]);e.splitBoundariesPreservingPositions(s),n.removeEmptyElements&&n.removeEmptyContainers(e);var r=C(e);if(r.length){D(r,function(e){n.isIgnorableWhiteSpaceNode(e)||n.getSelfOrAncestorWithClass(e)||!n.isModifiable(e)||n.applyToTextNode(e,s)});var i=r[r.length-1];e.setStartAndEnd(r[0],0,i,i.length),n.normalize&&n.postApply(r,e,s,!1),P(t,s)}var a=n.getEmptyElements(e);D(a,function(e){o(e,n.className)})},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(t){var n=e.getSelection(t);n.setRanges(this.applyToRanges(n.getAllRanges()))},undoToRange:function(e,t){var n=this;t=t||[];var s=R(t);e.splitBoundariesPreservingPositions(s),n.removeEmptyElements&&n.removeEmptyContainers(e,s);var r,i,o=C(e),a=o[o.length-1];if(o.length){n.splitAncestorWithClass(e.endContainer,e.endOffset,s),n.splitAncestorWithClass(e.startContainer,e.startOffset,s);for(var l=0,u=o.length;u>l;++l)r=o[l],i=n.getSelfOrAncestorWithClass(r),i&&n.isModifiable(r)&&n.undoToAncestor(i,s);e.setStartAndEnd(o[0],0,a,a.length),n.normalize&&n.postApply(o,e,s,!0),P(t,s)}var f=n.getEmptyElements(e);D(f,function(e){k(e,n.className)})},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(t){var n=e.getSelection(t),s=e.getSelection(t).getAllRanges();this.undoToRanges(s),n.setRanges(s)},isAppliedToRange:function(e){if(e.collapsed||""==e.toString())return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);var t=e.getNodes([3]);if(t.length)for(var n,s=0;n=t[s++];)if(!this.isIgnorableWhiteSpaceNode(n)&&y(e,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(e){var t=e.length;if(0==t)return!1;for(;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(t){var n=e.getSelection(t);return this.isAppliedToRanges(n.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},getElementsWithClassIntersectingRange:function(e){var t=[],n=this;return e.getNodes([3],function(e){var s=n.getSelfOrAncestorWithClass(e);s&&!z(t,s)&&t.push(s)}),t},detach:function(){}},M.util={hasClass:i,addClass:o,removeClass:k,getClass:a,hasSameClasses:f,hasAllClasses:c,replaceWithOwnChildren:v,elementsHaveSameNonClassAttributes:T,elementHasNonClassAttributes:E,splitNodeAt:O,isEditableElement:F,isEditingHost:b,isEditable:A},e.CssClassApplier=e.ClassApplier=M,e.createClassApplier=H,B.createAliasForDeprecatedMethod(e,"createCssClassApplier","createClassApplier",t)}),e},this);